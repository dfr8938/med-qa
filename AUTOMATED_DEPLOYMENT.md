# Автоматизированное развертывание Medical Q&A Portal

## Описание
Этот скрипт автоматически выполняет все шаги, описанные в `DEPLOYMENT.md`, одной командой, обеспечивая корректную настройку окружения, миграцию базы данных, установку зависимостей и запуск приложения в production-режиме.

## Функциональность
Скрипт выполняет следующие задачи:

1. Проверяет системные требования
2. Обновляет систему
3. Устанавливает необходимые пакеты (Node.js, PostgreSQL, Nginx)
4. Настраивает базу данных (создает базы данных и пользователей)
5. Развертывает приложение (устанавливает зависимости, создает сборку)
6. Настраивает переменные окружения с безопасными секретами
7. Выполняет миграции и сиды базы данных
8. Настраивает systemd сервис
9. Настраивает Nginx
10. Опционально настраивает SSL сертификат
11. Запускает приложение

## Требования
- Ubuntu 20.04 или выше
- Root доступ к серверу
- Доступ в интернет для установки пакетов

## Где запускать скрипт
Скрипт можно запустить из **любой директории**, так как он автоматически работает с директорией установки `/opt/med-qa-portal`. 

Если вы хотите запустить скрипт из директории проекта (где находится этот файл), используйте:
```bash
sudo ./automated-deploy.sh [параметры]
```

Если вы хотите запустить скрипт из другой директории, укажите полный путь:
```bash
sudo /path/to/automated-deploy.sh [параметры]
```

## Использование

### Базовое развертывание
```bash
sudo ./automated-deploy.sh
```

### Развертывание с IP-адресом и доменом
```bash
sudo ./automated-deploy.sh --domain medsester.ru --ip 130.49.149.185
```

### Развертывание с SSL
```bash
sudo ./automated-deploy.sh --domain medsester.ru --ip 130.49.149.185 --ssl
```

### Сброс и новое развертывание
```bash
sudo ./automated-deploy.sh --reset
```

### Все параметры
```bash
sudo ./automated-deploy.sh --domain medsester.ru --ip 130.49.149.185 --ssl --reset
```

### Просмотр справки
```bash
sudo ./automated-deploy.sh --help
```

## Параметры

| Параметр | Описание |
|----------|----------|
| `-d`, `--domain` | Доменное имя для настройки SSL |
| `-i`, `--ip` | IP-адрес сервера |
| `-s`, `--ssl` | Включить настройку SSL сертификата |
| `-r`, `--reset` | Сбросить существующую установку |
| `-h`, `--help` | Показать справку |

## Безопасность
Скрипт автоматически генерирует уникальные секреты для:
- JWT_SECRET
- Все переменные окружения

Пароли баз данных по умолчанию:
- Для production: генерируются автоматически
- Для разработки и тестирования: используются стандартные значения

## Логирование
Все операции логируются в файл `/var/log/med-qa-deploy.log`

## Проверка статуса приложения
После развертывания можно проверить статус приложения:
```bash
sudo systemctl status med-qa.service
```

## Просмотр логов приложения
```bash
sudo journalctl -u med-qa.service -f
```

## Обновление приложения
Для обновления приложения используйте существующий скрипт:
```bash
./deploy.sh
```

## Резервное копирование
Регулярное резервное копирование базы данных:
```bash
pg_dump med_qa_prod_db > backup_$(date +"%Y%m%d").sql
```

## Устранение неполадок

### Проблемы с базой данных
Если возникают проблемы с подключением к базе данных, проверьте:
1. Статус PostgreSQL: `sudo systemctl status postgresql`
2. Наличие баз данных: `sudo -u postgres psql -l`
3. Наличие пользователя: `sudo -u postgres psql -c "\du"`

### Проблемы с приложением
Если приложение не запускается:
1. Проверьте логи: `sudo journalctl -u med-qa.service`
2. Проверьте статус: `sudo systemctl status med-qa.service`
3. Проверьте конфигурацию Nginx: `sudo nginx -t`

### Проблемы с Nginx
Если веб-интерфейс недоступен:
1. Проверьте конфигурацию: `sudo nginx -t`
2. Перезапустите Nginx: `sudo systemctl restart nginx`
3. Проверьте доступность портов: `sudo ufw status`

## Настройка после развертывания

### Изменение паролей
1. Измените пароль пользователя PostgreSQL:
   ```bash
   sudo -u postgres psql
   ALTER USER postgres PASSWORD 'новый_пароль';
   \q
   ```

2. Обновите пароли в файлах конфигурации:
   - `server/.env.development`
   - `server/.env.test`

3. Перезапустите сервис:
   ```bash
   sudo systemctl restart med-qa.service
   ```

### Настройка Firewall
```bash
sudo ufw allow OpenSSH
sudo ufw allow 'Nginx Full'
sudo ufw enable
```

## Мониторинг
Логи приложения доступны через journalctl:
```bash
sudo journalctl -u med-qa.service -f